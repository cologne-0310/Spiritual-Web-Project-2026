<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¢ºèªçµå¸³ | æºé»èº«&å¿ƒéˆå·¥ä½œåŠ</title>
    <!-- å­—é«”èˆ‡æ¨£å¼ (Fonts & Styles) -->
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Outfit:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body style="background: #f8f9fa;">
    <!-- å°è¦½åˆ— (Navbar) -->
    <nav class="navbar">
        <div class="container nav-content">
            <a href="index.html" class="logo">
                <img src="https://raw.githubusercontent.com/cologne-0310/AG_TEST/main/assets/logo.png" alt="æºé» logo">
                æºé»
                <span class="logo-sub">èº«&å¿ƒéˆå·¥ä½œåŠ</span>
            </a>
            <ul class="nav-links">
                <li><a href="about.html">é—œæ–¼æˆ‘å€‘</a></li>
                <li><a href="academy.html">å„é¡èª²ç¨‹</a></li>
                <li><a href="shop.html">ç™‚ç™’æœå‹™</a></li>
                <li><a href="gemini-page.html">AI å¯¦é©—å®¤</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <div class="checkout-container">
            <!-- Left: Checkout Form -->
            <div class="checkout-card">
                <h2>é¡§å®¢è³‡æ–™</h2>
                <form id="checkout-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>çœŸå¯¦å§“å</label>
                            <input type="text" class="form-control" placeholder="æ‚¨çš„å§“å" required id="cust-name">
                        </div>
                        <div class="form-group">
                            <label>è¯çµ¡é›»è©±</label>
                            <input type="tel" class="form-control" placeholder="09XX-XXXXXX" required id="cust-phone">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>é›»å­éƒµä»¶</label>
                        <input type="email" class="form-control" placeholder="service@example.com" required
                            id="cust-email">
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨»äº‹é … (é¸å¡«)</label>
                        <textarea class="form-control" rows="3" placeholder="å¦‚æœ‰ç‰¹æ®Šçš„é ç´„éœ€æ±‚ï¼Œè«‹åœ¨æ­¤å‘ŠçŸ¥..."></textarea>
                    </div>

                    <h3 style="margin-top: 3rem;">ä»˜æ¬¾æ–¹å¼</h3>
                    <div class="payment-options" style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                        <label class="payment-option"
                            style="border: 1.5px solid #eee; padding: 1rem; border-radius: 8px; display: flex; align-items: center; gap: 1rem; cursor: pointer;">
                            <input type="radio" name="payment" value="bank" checked>
                            <div>
                                <div style="font-weight: 600;">éŠ€è¡Œè½‰å¸³</div>
                                <div style="font-size: 0.8rem; color: #64748b;">è½‰å¸³å¾Œè«‹å‘ŠçŸ¥å¾Œäº”ç¢¼</div>
                            </div>
                        </label>
                        <label class="payment-option"
                            style="border: 1.5px solid #eee; padding: 1rem; border-radius: 8px; display: flex; align-items: center; gap: 1rem; cursor: pointer;">
                            <input type="radio" name="payment" value="onsite">
                            <div>
                                <div style="font-weight: 600;">ç¾å ´ä»˜è²»</div>
                                <div style="font-size: 0.8rem; color: #64748b;">èª²ç¨‹/æœå‹™ç•¶æ—¥æ”¯ä»˜</div>
                            </div>
                        </label>
                    </div>

                    <p style="font-size: 0.8rem; color: #94a3b8; line-height: 1.5;">
                        é€å‡ºè¨‚å–®å³è¡¨ç¤ºæ‚¨åŒæ„æœ¬å·¥ä½œåŠä¹‹<a href="guide.html" target="_blank"
                            style="text-decoration: underline; color: var(--accent-color);">æœå‹™æ¢æ¬¾èˆ‡é€€è²»è¦å®š</a>ã€‚
                    </p>

                    <button type="submit" class="place-order-btn" id="submit-btn" disabled>
                        ç¢ºèªè¨‚å–®ä¸¦é€å‡º
                    </button>
                </form>
            </div>

            <!-- Right: Order Summary -->
            <div class="checkout-card" style="padding: 2rem;">
                <h3>è¨‚å–®æ‘˜è¦</h3>
                <div id="order-summary-list">
                    <!-- Loaded by cart.js -->
                    <div style="text-align: center; color: #999; padding: 2rem;">è¼‰å…¥ä¸­...</div>
                </div>

                <div class="checkout-total-row">
                    <span class="total-label">ç¸½è¨ˆé‡‘é¡</span>
                    <span class="total-amount" id="final-total-amount">NT$ 0</span>
                </div>

                <div style="margin-top: 2rem; background: #fffcea; padding: 1rem; border-radius: 8px; font-size: 0.85rem;">
                    <strong>ğŸ’¡ è²¼å¿ƒæé†’</strong><br>
                    é€å‡ºè¨‚å–®å¾Œï¼Œç³»çµ±å°‡è‡ªå‹•ç‚ºæ‚¨ä¿ç•™é ç´„åé¡ï¼Œæˆ‘å€‘å°‡æœ‰å°ˆäººèˆ‡æ‚¨è¯ç¹«ã€‚
                </div>
            </div>
        </div>
    </main>

    <!-- Success Modal (Simplified) -->
    <div id="success-overlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
        <div
            style="background:white; padding:3rem; border-radius:16px; text-align:center; max-width:400px; box-shadow:0 10px 40px rgba(0,0,0,0.2);">
            <div style="font-size:4rem; margin-bottom:1.5rem;">âœ¨</div>
            <h2 style="margin-bottom:1rem;">æ„Ÿè¬æ‚¨çš„é ç´„ï¼</h2>
            <p style="color:#64748b; margin-bottom:2rem; line-height:1.6;">è¨‚å–®å·²æˆåŠŸé€å‡ºï¼Œå·¥ä½œåŠå°ˆå“¡å°‡æ–¼ 24 å°æ™‚å…§èˆ‡æ‚¨è¯ç¹«ç¢ºèªç´°ç¯€ã€‚</p>
            <a href="index.html" class="btn btn-primary" style="display:block; width:100%;">è¿”å›é¦–é </a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="cart.js"></script>
    <script>
        // çµå¸³é é¢å°ˆå±¬é‚è¼¯
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('checkout-form');
            const submitBtn = document.getElementById('submit-btn');
            const overlay = document.getElementById('success-overlay');

            // ç¢ºä¿è³¼ç‰©è»Šæœ‰æ±è¥¿æ‰å•Ÿç”¨æŒ‰éˆ•
            setTimeout(() => {
                const savedCart = localStorage.getItem('soul_cart');
                const cartData = savedCart ? JSON.parse(savedCart) : [];
                if (cartData.length > 0) {
                    submitBtn.disabled = false;
                }
            }, 500);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitBtn.disabled = true;
                submitBtn.innerText = 'è™•ç†ä¸­...';

                // æº–å‚™æ•¸æ“š
                const savedCart = localStorage.getItem('soul_cart');
                const cartData = JSON.parse(savedCart);
                const orderTotal = cartData.reduce((acc, item) => acc + (item.price * item.quantity), 0);

                const orderData = {
                    customer_name: document.getElementById('cust-name').value,
                    customer_phone: document.getElementById('cust-phone').value,
                    customer_email: document.getElementById('cust-email').value,
                    total_amount: orderTotal,
                    items_json: cartData,
                    status: 'Pending'
                };

                // é€å‡ºåˆ° Supabase
                if (window.supabaseClient) {
                    try {
                        const { error } = await supabaseClient
                            .from('orders')
                            .insert([orderData]);

                        if (error) throw error;

                        // æˆåŠŸå¾Œæ¸…é™¤è³¼ç‰©è»Š
                        localStorage.removeItem('soul_cart');
                        overlay.style.display = 'flex';
                    } catch (err) {
                        alert('é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šï¼š' + err.message);
                        submitBtn.disabled = false;
                        submitBtn.innerText = 'ç¢ºèªè¨‚å–®ä¸¦é€å‡º';
                    }
                }
            });
        });
    </script>
</body>

</html>
